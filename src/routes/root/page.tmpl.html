<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>szambo.tsaryk.com</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      hr {
        width: 100%;
      }
      footer {
        display: flex;
      }
      .levels td:nth-child(2) {
        text-align: center;
      }
      .logs td:nth-child(2) {
        text-align: center;
      }
      .chart-wrapper {
        max-width: 800px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    {{levels}}
    <div class="chart-wrapper">
      <canvas id="chart"></canvas>
    </div>
    {{logs}}
    <hr />
    <footer>
      <a id="manualLink" href="">Auto + Manual</a>
      &nbsp;|&nbsp;
      <a id="moreDataLink" href="">More data</a>
      &nbsp;|&nbsp;
      <a href="{{remoteControlHref}}">Remote control</a>
      &nbsp;|&nbsp;
      <a href="https://github.com/phts/szambo.tsaryk.com" target="_blank">© Phil Tsaryk, 2025</a>
    </footer>
    <script>
      const moreDataUrl = new URL(document.location)
      if (!moreDataUrl.searchParams.has('more')) {
        moreDataUrl.searchParams.append('more', 'true')
      } else {
        moreDataUrl.searchParams.delete('more')
      }
      document.getElementById('moreDataLink').setAttribute('href', moreDataUrl.toString())
      const manualLinkUrl = new URL(document.location)
      if (!manualLinkUrl.searchParams.has('manual')) {
        manualLinkUrl.searchParams.append('manual', 'true')
      } else {
        manualLinkUrl.searchParams.delete('manual')
      }
      document.getElementById('manualLink').setAttribute('href', manualLinkUrl.toString())
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const ctx = document.getElementById('chart')
      const plugin = {
        id: 'horizontalLine',
        defaults: {},
        afterDraw: (chart, _, options) => {
          const {ctx} = chart
          const {left, right} = chart.chartArea
          const scale = chart.scales.y
          const width = options.width || 1
          const color = options.color || '#000'
          const value = options.value ? scale.getPixelForValue(options.value) : 0
          ctx.beginPath()
          ctx.lineWidth = width
          ctx.moveTo(left, value)
          ctx.lineTo(right, value)
          ctx.strokeStyle = color
          ctx.stroke()
        },
      }
      Chart.register(plugin)
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: '{{chartLabels}}',
          datasets: [
            {
              data: '{{chartData}}',
              borderWidth: 1,
            },
          ],
        },
        options: {
          elements: {
            bar: {
              backgroundColor: (ctx) => (ctx.parsed.y >= 83 ? '#f60' : '#000'),
            },
          },
          scales: {
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 90,
                minRotation: 90,
                callback: function (value) {
                  return this.getLabelForValue(value).split('T')[0]
                },
              },
              grid: {
                display: false,
              },
            },
            y: {
              beginAtZero: true,
              max: 100,
              min: 0,
              border: {
                dash: [5, 5],
              },
              ticks: {
                callback: (value) => value + '%',
              },
            },
            cubes: {
              position: 'right',
              max: 6,
              min: 0,
              ticks: {
                callback: (value) => value + 'm³',
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
            horizontalLine: {
              width: 1,
              color: '#f60',
              value: 83,
            },
            tooltip: {
              callbacks: {
                title: (context) => new Date(Date.parse(context[0].label)).toLocaleString(),
              },
            },
          },
        },
      })
    </script>
  </body>
</html>
