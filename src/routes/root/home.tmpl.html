<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="stylesheet" href="/style.css" />
    <title>szambo.tsaryk.com</title>
  </head>
  <body class="home">
    {{adminPanel}}
    <h3>
      Levels
      <span class="freq"
        >[<a href="{{freq1Href}}"><sup>1</sup>&frasl;<sub>1</sub></a
        >]&nbsp;[<a href="{{freq2Href}}"><sup>2</sup>&frasl;<sub>1</sub></a
        >]&nbsp;[<a href="{{freq3Href}}"><sup>3</sup>&frasl;<sub>1</sub></a
        >]&nbsp;[<a href="{{freq4Href}}"><sup>4</sup>&frasl;<sub>1</sub></a
        >]</span
      >
    </h3>
    <div class="chart-wrapper">
      <canvas id="chart"></canvas>
    </div>
    {{levels}}
    <h3>Logs</h3>
    {{logs}}
    <hr />
    <footer>
      <a href="{{levelsHref}}">Levels</a>
      &nbsp;|&nbsp;
      <a href="{{logsHref}}">Logs</a>
      &nbsp;|&nbsp;
      <a href="/">Admin mode</a>
      &nbsp;|&nbsp;
      <a href="https://github.com/phts/szambo.tsaryk.com" target="_blank">© Phil Tsaryk, 2025</a>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
      const ctx = document.getElementById('chart')
      const plugin = {
        id: 'horizontalLine',
        defaults: {},
        afterDraw: (chart, _, options) => {
          const {ctx} = chart
          const {left, right} = chart.chartArea
          const scale = chart.scales.y
          const width = options.width || 1
          const color = options.color || '#000'
          const value = options.value ? scale.getPixelForValue(options.value) : 0
          ctx.beginPath()
          ctx.lineWidth = width
          ctx.moveTo(left, value)
          ctx.lineTo(right, value)
          ctx.strokeStyle = color
          ctx.stroke()
        },
      }
      Chart.register(plugin)
      new Chart(ctx, {
        type: 'bar',
        data: {
          datasets: [
            {
              data: '{{chartData}}',
              borderWidth: 1,
            },
          ],
        },
        options: {
          animation: false,
          elements: {
            bar: {
              backgroundColor: (ctx) => (ctx.parsed.y >= 83 ? '#f60' : dark ? '#c8c6c3' : '#000'),
            },
          },
          scales: {
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 90,
                minRotation: 90,
                callback: function (value) {
                  const date = new Date(Date.parse(this.getLabelForValue(value)))
                  return `${date.getDate().toString().padStart('2', '0')}.${(date.getMonth() + 1).toString().padStart('2', '0')}`
                },
              },
              grid: {
                display: false,
              },
            },
            y: {
              beginAtZero: true,
              max: 100,
              min: 0,
              border: {
                dash: [5, 5],
              },
              ticks: {
                callback: (value) => value + '%',
                color: dark ? '#c8c6c3' : undefined,
              },
              grid: {
                color: dark ? '#333' : undefined,
              },
            },
            cubes: {
              position: 'right',
              max: 6,
              min: 0,
              ticks: {
                callback: (value) => value + 'm³',
                color: dark ? '#c8c6c3' : undefined,
              },
              grid: {
                color: dark ? '#333' : undefined,
              },
            },
          },
          plugins: {
            legend: {
              display: false,
            },
            horizontalLine: {
              width: 1,
              color: '#f60',
              value: 83,
            },
            tooltip: {
              callbacks: {
                title: (ctx) =>
                  [new Date(Date.parse(ctx[0].label)).toLocaleString(), ctx[0].raw.label_m3, ctx[0].raw.errorRate]
                    .filter(Boolean)
                    .join('\n'),
              },
            },
          },
        },
      })
    </script>
  </body>
</html>
